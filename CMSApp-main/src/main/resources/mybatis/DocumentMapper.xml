<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd">
<mapper namespace="com.sds.cmsapp.model.document.DocumentDAO">
	
	<!-- resultType="Document" -->
 	<select id="select" parameterType="int" resultType="Document">
		select * from document where document_idx=#{document_idx}
	</select>
	
	<resultMap type="Document" id="DocumentMap">
		<id 			column="document_idx" 	property="document_idx"/>
		<result 		column="hit" 				property="hit"/>		
			
			<!-- 하나만 가져오기 -->
	 		<association
			column="document_idx" 
			property="latestRegisteredStatusLog" 
			javaType="StatusLog"
			select="com.sds.cmsapp.model.statuslog.StatusLogDAO.selectLatestRegisteredStatusLogByDocumentIdx"/> 
		
	</resultMap>
	
	<!-- resultMap="DocumentMap" -->
	<select id="selectByDocumentIdx" parameterType="int" resultMap="DocumentMap">
		select * from document where document_idx=#{document_idx}
	</select>
	
	
	
    <!-- 문서 삽입 -->
    <insert id="documentInsert" parameterType="Document">
        INSERT INTO document (emp_idx, folder_idx) VALUES (#{emp.emp_idx}, #{folder.folder_idx})
        <selectKey keyColumn="document_idx" keyProperty="document_idx" resultType="int" order="AFTER">
			select last_insert_id() as document_idx
		</selectKey>
    </insert>
    
    <!-- 버전로그 삽입 -->
    <insert id="versionInsert" parameterType="VersionLog">
<!--     INSERT INTO version_log(branched_version_log_idx, emp_idx, project_idx, folder_idx, document_idx, version, title, content, comments) 
    VALUES (#{branched_version_log_idx},#{emp_idx},#{project_idx},#{folder_idx},#{document_idx},#{version}, #{title}, #{content}, #{comments});
     -->
    INSERT INTO version_log(branched_version_log_idx,emp_idx,document_idx,version,title,content,comments) 
    VALUES (NULL,7,#{document.document_idx}, 1,#{title}, #{content},'초안')
    
        <selectKey keyColumn="version_log_idx" keyProperty="version_log_idx" resultType="int" order="AFTER">
			select last_insert_id() as version_log_idx
		</selectKey>
    </insert>
    
    <insert id="documentVersionInsert" parameterType="DocumentVersion">
    	insert into document_version (document_idx, version_log_idx)
    	values (#{document.document_idx}, #{versionLog.version_log_idx})
    </insert>
	
	<!-- folder_idx, version_log_idx -> 뷰페이지  -->
	<resultMap type="Document" id="DocumentListMap">
		<id column="document_idx" property="document_idx"/>
		<result column="folder_idx" property="folder_idx"/>
	</resultMap>
	
	
	<!-- 문서 목록 조회 -->
    <select id="documentListSelect" resultType="Document">
        SELECT document_idx 
        FROM document 
        WHERE folder_idx = #{folder.folder_idx}
    </select>
    
</mapper>